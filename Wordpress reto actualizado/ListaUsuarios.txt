<?php
session_start();
if(isset($_SESSION["id"])){    //Cuando este la session iniciada te muestra la pagina

if($_SESSION["rol"]=="administrador"){
?>

<!DOCTYPE html>
<html>
  	<head>
    		<meta charset="utf-8">
    		<title>Lista Usuarios</title>
        <style>
@import url("https://fonts.googleapis.com/css2?family=Sansita+Swashed:wght@600&display=swap");


@media screen and (max-width: 900px) {
       table {
           width:100%;
           background: #fff;
           border-collapse: collapse;
       }
       thead {
           display: none;
       }

       tr:nth-of-type(2n) {
           background-color: inherit;
       }

       tr td:first-child {
           background: #f0f0f0;
           font-weight:bold;
           font-size:1.3em;

       }
       tbody td {
           display: block;
           text-align:center;
       }
       tbody td:before {
           content: attr(data-th);
           display: block;
           text-align:center;
       }
}

       th {
            background-color:#16B4DB;
            color: #ffffff;
       }

       td {
            background-color: #f3f3f3;
            font-weight: bold;
            color: #40403f;
       }

        </style>
  	</head>

  	<body>
             <div class="contit"><h3>LISTA DE USUARIOS</h3></div>
    		<table class="styled-table">
                <thead>
 		<tr>
    			<th>Id</th>
    			<th>Email</th>
    			<th>Nombre Usuario</th>
    			<th>Rol</th>
                	<th>Ultima Sesi√≥n</th>
                        <th>Estado</th>
                        <th>Activacion</th>
                        <th>Modificar</th>
  		</tr>
                <thead>
<!-- cerrar tabla despues del php -->



<?php
//echo "Usuario".$_SESSION["usuario"]; //ver perfil de usuario echo
//echo "Id".$_SESSION["id"]; //ver perfil de usuario echo
//echo "Rol".$_SESSION["rol"]; //ver perfil de usuario echo


  
		$server = 'localhost';
		$username = 'user_wordpress';
		$password = '%myU_w3sql';
		$database = 'wordpress';

    try {
	$base = new PDO("mysql:host=$server;dbname=$database;", $username, $password);
	$base->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        $sql="SELECT * FROM usuarios";

            $resultado=$base->prepare($sql);

            $resultado->execute();
            
            $numero_registro=$resultado->rowCount(); 
        
            foreach ($resultado as $row) {	//extrae los datos de la sql "El select" para crear la sesion abajo
		extract($row);

?>  
                 <tbody> 
		 <tr>
			<td><?php echo $intIdUser; ?></td>
			<td><?php echo $vchEmail; ?></td>
			<td><?php echo $vchNombreUser; ?></td>
			<td><?php echo $vchRol; ?></td>
                        <td><?php echo $dateUltimaConexion; ?></td>
                        <td><?php echo $vchEstado; ?></td>

                       <td>
                            <form action="" method="POST">
                                  <input name="iduserModifi" type="hidden" value="<?php echo $intIdUser; ?>"/>
                                  <input type="submit" value="Modificar" name="modifi" />
                            </form>
                        </td>

<!-- Dos td con un if -->
<?php 
$activado="activado";
if($_SESSION["estado"] === $activado) {

?>
                        <td>
                            <form action="" method="POST">
                                  <input name="idLista" type="hidden" value="<?php echo $intIdUser; ?>"/>
                                  <input name="estadoF" type="hidden" value="desactivado"/>
                                  <input type="submit" value="Desactivar" name="estado" />
                            </form>
                        </td>
<?php
} else {
?>
                       <td>
                            <form action="" method="POST">
                                  <input name="idLista" type="hidden" value="<?php echo $intIdUser; ?>"/>
                                  <input name="estadoF" type="hidden" value="activado"/>
                                  <input type="submit" value="Activar" name="estado" />
                            </form>
                        </td>
		 </tr>
                 <tbody>
<?php
} //cierre else de estado

}  //cierre foreach
?>


<?php
       
if(isset($_POST["estado"])){

            $idL=$_POST["idLista"];
            $estF=$_POST["estadoF"];
            $_SESSION["estado"] = $estF;

            $sql1="update usuarios set vchEstado= :estado where intIdUser= :idF";
            $resultado1=$base->prepare($sql1); 
            $resultado1->bindValue(":idF", $idL);
            $resultado1->bindValue(":estado", $estF);
            $resultado1->execute();
            header('Location: https://www.grupo2ciber.com/?page_id=81');

} else {
echo "";
}
  

if(isset($_POST["modifi"])){
$usulom=$_POST["iduserModifi"];
$_SESSION["idmodifc"] = $usulom;
header('Location: https://www.grupo2ciber.com/?page_id=642');

}
  

    }  catch (PDOException $e) {
	      die('Connection Failed: ' . $e->getMessage());
	} //cierre try y catch

$use=$_SESSION["usuario"];
$ro=$_SESSION["rol"];
?>

</table>

<h5 class="textoMess"><?php echo "Usuario conectado --> ".$use . "</br> Rol --> ".$ro; ?></h5>

	</body>

</html>

<?php
} else {
     header('Location: https://www.grupo2ciber.com/?page_id=37');
}
?>

</body>
</html>


<?php
} else {
      header('Location: https://www.grupo2ciber.com');     //Te redirige a la pagina de "LOGIN"
}
?>